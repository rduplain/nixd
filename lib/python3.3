#!/bin/bash
# Install python3.3 virtualenv, install packages in requirements.txt.
#
# Set pip to cache downloads with environment variable:
#
#     export PIP_DOWNLOAD_CACHE=$HOME/.pip/cache

PYTHON=python3.3
PREFIX=$NIXD_OPT/$PYTHON

UNPACKED=virtualenv-1.9.1
ARCHIVE=$UNPACKED.tar.gz

REQUIREMENTS=$NIXD_ETC/$PYTHON-requirements.txt
PIP=$PREFIX/bin/pip

check() {
    nixd_ls $PREFIX/bin/python
    nixd_ls $PREFIX/bin/pip
    nixd_newer_than $REQUIREMENTS
}

resources() {
    echo https://pypi.python.org/packages/source/v/virtualenv/$ARCHIVE
}

pretest() {
    nixd check_for_program $PYTHON
    nixd_ls $REQUIREMENTS
}

install() {
    if [ ! -e $PREFIX/bin/python ]; then
        nixd_echo "Installing $PYTHON virtualenv."
        tar -xzf $ARCHIVE
        VIRTUALENV_PY=`pwd`/$UNPACKED/virtualenv.py
        nixd_echo "Ensuring virtualenv.py is unpacked ..."
        nixd_ls $VIRTUALENV_PY
        nixd_echo "Installing virtualenv to $PREFIX ..."
        cd $NIXD_OPT
        $PYTHON $VIRTUALENV_PY --distribute --no-site-packages $PYTHON
    fi
    nixd_echo "Installing packages listed in $REQUIREMENTS ..."
    $PIP install -r $REQUIREMENTS
}

nixd_run "$@"
