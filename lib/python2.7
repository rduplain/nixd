#!/bin/bash
# Install python2.7 virtualenv, install packages in requirements.txt.
#
# Set pip to cache downloads with environment variable:
#
#     export PIP_DOWNLOAD_CACHE=$HOME/.pip/cache

PYTHON=python2.7
PREFIX=$NIXD_OPT/$PYTHON

UNPACKED=virtualenv-1.11.4
ARCHIVE=$UNPACKED.tar.gz

REQUIREMENTS=$NIXD_ETC/$PYTHON-requirements.txt
PIP=$PREFIX/bin/pip

export PIP_DOWNLOAD_CACHE=${PIP_DOWNLOAD_CACHE-$NIXD_SRC}

check() {
    nixd_ls $PREFIX/bin/python
    nixd_ls $PREFIX/bin/pip
    if [ -e $REQUIREMENTS ]; then
        nixd_newer_than $REQUIREMENTS
    fi
}

resources() {
    echo https://pypi.python.org/packages/source/v/virtualenv/$ARCHIVE
}

pretest() {
    nixd check_for_program $PYTHON
}

install() {
    if [ ! -e $PREFIX/bin/python ]; then
        nixd_echo "Installing $PYTHON virtualenv."
        tar -xzf $ARCHIVE
        VIRTUALENV_PY=`pwd`/$UNPACKED/virtualenv.py
        nixd_echo "Ensuring virtualenv.py is unpacked ..."
        nixd_ls $VIRTUALENV_PY
        nixd_echo "Installing virtualenv to $PREFIX ..."
        cd $NIXD_OPT
        $PYTHON $VIRTUALENV_PY --distribute --no-site-packages $PYTHON
    fi
    if [ -e $REQUIREMENTS ]; then
        nixd_echo "Installing packages listed in $REQUIREMENTS ..."
        $PIP install -r $REQUIREMENTS
    fi
}

nixd_run "$@"
