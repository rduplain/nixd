#!/bin/bash
# nixd main program for relatively self-contained configuration management.

# Useful environment variables, set in main function.
declare PROG
declare PROG_DIR
declare PREFIX

usage() {
    # Print program usage to stderr and exit with status code 1.

    exec >&2 # Redirect all further stdout to stderr.

    if [ $# -gt 0 ]; then
        # Print message argument, if given.
        echo "$@"
        echo
    fi

    echo "usage: $PROG <command>"
    echo
    echo "Configurations are in $PROG/etc/, installations are in $PROG/usr/."
    echo
    echo "Commands:"
    echo "boot - Initialize stack specified in configuration."
    exit 1
}

boot() {
    export PREFIX
    echo "PREFIX: $PREFIX"
    echo "TODO"
}

main() {
    PROG="$( basename "${BASH_SOURCE[0]}" )"
    local script_dir="$( cd -P "$( dirname "${BASH_SOURCE[0]}" )" && pwd )"
    PROG_DIR="$( dirname "$script_dir" )"
    PREFIX=$PROG_DIR/usr

    # Print usage and exit if there are no arguments.
    if [ $# -eq 0 ]; then
        usage
    fi

    local command=$1
    shift;

    if [ "`type -t $command`" != "function" ]; then
        usage "$PROG: $command is not a valid command."
    fi

    $command "$@"
}

main "$@"
